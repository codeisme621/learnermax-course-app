AWSTemplateFormatVersion: 2010-09-09
Description: >-
  LearnerMax Course Backend - Express.js API with Lambda Web Adapter
Transform:
- AWS::Serverless-2016-10-31

Parameters:
  Environment:
    Type: String
    Default: preview
    AllowedValues: [preview, prod]
    Description: Environment name (preview or prod)

  FrontendDomain:
    Type: String
    Description: Frontend domain for OAuth callbacks (e.g., https://www.learnermax.com)

  GoogleOAuthSecretArn:
    Type: String
    Description: ARN of Secrets Manager secret containing Google OAuth credentials

  AdotLayerArn:
    Type: String
    Default: arn:aws:lambda:us-east-1:615299751070:layer:AWSOpenTelemetryDistroJs:10
    Description: ARN for AWS OpenTelemetry Distro Lambda layer (supports ARM64)

  CloudFrontKeyPairId:
    Type: String
    Description: CloudFront key pair ID for signing video URLs (generated via AWS Console)

  CloudFrontPublicKeyId:
    Type: String
    Description: CloudFront public key ID for KeyGroup (created via create-public-key API)

  CloudFrontKeyGroupId:
    Type: String
    Description: CloudFront key group ID (created manually via create-key-group API)

  SESFromEmail:
    Type: String
    Default: support@learnwithrico.com
    Description: SES verified sender email address for transactional emails

  SESReplyToEmail:
    Type: String
    Default: support@learnwithrico.com
    Description: Reply-to email address for transactional emails

Conditions:
  IsProd: !Equals [!Ref Environment, prod]

# Resources declares the AWS resources that you want to include in the stack
# https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/resources-section-structure.html
Resources:
  # Cognito User Pool
  LearnerMaxUserPool:
    Type: AWS::Cognito::UserPool
    DependsOn: PostConfirmationInvokePermission
    Properties:
      UserPoolName: !Sub learnermax-${Environment}
      AutoVerifiedAttributes:
        - email
      UsernameAttributes:
        - email
      UsernameConfiguration:
        CaseSensitive: false
      Policies:
        PasswordPolicy:
          MinimumLength: 8
          RequireUppercase: true
          RequireLowercase: true
          RequireNumbers: true
          RequireSymbols: true
      Schema:
        - Name: email
          AttributeDataType: String
          Required: true
          Mutable: true
        - Name: name
          AttributeDataType: String
          Required: true
          Mutable: true
      EmailConfiguration:
        EmailSendingAccount: DEVELOPER
        From: !Sub "${SESFromEmail}"
        SourceArn: !Sub "arn:aws:ses:${AWS::Region}:${AWS::AccountId}:identity/learnwithrico.com"
      AdminCreateUserConfig:
        AllowAdminCreateUserOnly: false
      LambdaConfig:
        PostConfirmation: !GetAtt PostConfirmationFunction.Arn
      UserPoolTags:
        Environment: !Ref Environment
        Project: LearnerMax

  # Cognito User Pool Domain
  LearnerMaxUserPoolDomain:
    Type: AWS::Cognito::UserPoolDomain
    Properties:
      Domain: !Sub learnermax-${Environment}-${AWS::AccountId}
      UserPoolId: !Ref LearnerMaxUserPool

  # Google Identity Provider
  LearnerMaxGoogleIdentityProvider:
    Type: AWS::Cognito::UserPoolIdentityProvider
    Properties:
      UserPoolId: !Ref LearnerMaxUserPool
      ProviderName: Google
      ProviderType: Google
      ProviderDetails:
        client_id: !Sub '{{resolve:secretsmanager:${GoogleOAuthSecretArn}:SecretString:client_id}}'
        client_secret: !Sub '{{resolve:secretsmanager:${GoogleOAuthSecretArn}:SecretString:client_secret}}'
        authorize_scopes: openid email profile
      AttributeMapping:
        email: email
        name: name
        username: sub

  # Cognito User Pool Client
  LearnerMaxUserPoolClient:
    Type: AWS::Cognito::UserPoolClient
    DependsOn: LearnerMaxGoogleIdentityProvider
    Properties:
      ClientName: !Sub learnermax-client-${Environment}
      UserPoolId: !Ref LearnerMaxUserPool
      GenerateSecret: false
      ExplicitAuthFlows:
        - ALLOW_USER_SRP_AUTH
        - ALLOW_USER_PASSWORD_AUTH
        - ALLOW_REFRESH_TOKEN_AUTH
        - ALLOW_ADMIN_USER_PASSWORD_AUTH
      SupportedIdentityProviders:
        - COGNITO
        - Google
      CallbackURLs:
        - !Sub ${FrontendDomain}/api/auth/callback/cognito
        - http://localhost:3000/api/auth/callback/cognito
      LogoutURLs:
        - !Ref FrontendDomain
        - http://localhost:3000
      AllowedOAuthFlows:
        - code
      AllowedOAuthFlowsUserPoolClient: true
      AllowedOAuthScopes:
        - openid
        - email
        - profile
      PreventUserExistenceErrors: ENABLED
      AccessTokenValidity: 1
      IdTokenValidity: 1
      RefreshTokenValidity: 30
      TokenValidityUnits:
        AccessToken: hours
        IdToken: hours
        RefreshToken: days

  # DynamoDB Education Table (Single-Table Design)
  EducationTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub learnermax-education-${Environment}
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: PK
          AttributeType: S
        - AttributeName: SK
          AttributeType: S
        - AttributeName: GSI1PK
          AttributeType: S
        - AttributeName: GSI1SK
          AttributeType: S
        - AttributeName: email
          AttributeType: S
      KeySchema:
        - AttributeName: PK
          KeyType: HASH
        - AttributeName: SK
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: GSI1
          KeySchema:
            - AttributeName: GSI1PK
              KeyType: HASH
            - AttributeName: GSI1SK
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: email-index
          KeySchema:
            - AttributeName: email
              KeyType: HASH
          Projection:
            ProjectionType: ALL
      StreamSpecification:
        StreamViewType: NEW_AND_OLD_IMAGES
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Project
          Value: LearnerMax

  # S3 Bucket for Video Storage
  VideoStorageBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub learnermax-videos-${Environment}
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      VersioningConfiguration:
        Status: Enabled
      LifecycleConfiguration:
        Rules:
          - Id: DeleteOldVersions
            Status: Enabled
            NoncurrentVersionExpirationInDays: 30
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Project
          Value: LearnerMax

  # CloudFront Origin Access Identity for S3 video access
  VideoCloudFrontOAI:
    Type: AWS::CloudFront::CloudFrontOriginAccessIdentity
    Properties:
      CloudFrontOriginAccessIdentityConfig:
        Comment: !Sub OAI for learnermax-videos-${Environment}

  # S3 Bucket Policy: Allow only CloudFront OAI to read videos
  VideoStorageBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref VideoStorageBucket
      PolicyDocument:
        Statement:
          - Sid: AllowCloudFrontOAIReadAccess
            Effect: Allow
            Principal:
              CanonicalUser: !GetAtt VideoCloudFrontOAI.S3CanonicalUserId
            Action:
              - s3:GetObject
            Resource: !Sub ${VideoStorageBucket.Arn}/*

  # CloudFront Distribution for video delivery
  VideoCloudFrontDistribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Comment: !Sub LearnerMax Video Distribution - ${Environment}
        Enabled: true
        HttpVersion: http2and3
        PriceClass: PriceClass_100
        Origins:
          - Id: S3VideoOrigin
            DomainName: !GetAtt VideoStorageBucket.RegionalDomainName
            S3OriginConfig:
              OriginAccessIdentity: !Sub origin-access-identity/cloudfront/${VideoCloudFrontOAI}
        DefaultCacheBehavior:
          TargetOriginId: S3VideoOrigin
          ViewerProtocolPolicy: redirect-to-https
          AllowedMethods:
            - GET
            - HEAD
            - OPTIONS
          CachedMethods:
            - GET
            - HEAD
          Compress: true
          CachePolicyId: 658327ea-f89d-4fab-a63d-7e88639e58f6  # CachingOptimized managed policy
          ResponseHeadersPolicyId: !Ref VideoResponseHeadersPolicy
          TrustedKeyGroups:
            - !Ref CloudFrontKeyGroupId
        ViewerCertificate:
          CloudFrontDefaultCertificate: true

  # CloudFront Response Headers Policy for CORS
  VideoResponseHeadersPolicy:
    Type: AWS::CloudFront::ResponseHeadersPolicy
    Properties:
      ResponseHeadersPolicyConfig:
        Name: !Sub learnermax-video-cors-${Environment}
        Comment: CORS policy for video player access from frontend
        CorsConfig:
          AccessControlAllowOrigins:
            Items:
              - !Ref FrontendDomain
              - http://localhost:3000
          AccessControlAllowHeaders:
            Items:
              - '*'
          AccessControlAllowMethods:
            Items:
              - GET
              - HEAD
              - OPTIONS
          AccessControlAllowCredentials: false
          AccessControlExposeHeaders:
            Items:
              - Content-Length
              - Content-Range
              - ETag
          OriginOverride: true

  # SNS Topic for Student Onboarding
  StudentOnboardingTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: !Sub learnermax-student-onboarding-${Environment}
      DisplayName: Student Onboarding Events
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Project
          Value: LearnerMax

  # Dead Letter Queue for Student Onboarding
  StudentOnboardingDLQ:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub learnermax-student-onboarding-dlq-${Environment}
      MessageRetentionPeriod: 1209600
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Project
          Value: LearnerMax

  # SNS Topic for Transactional Emails (Enrollment & Meetup Signup)
  TransactionalEmailTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: !Sub learnermax-transactional-email-${Environment}
      DisplayName: Transactional Email Events
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Project
          Value: LearnerMax
        - Key: Feature
          Value: TransactionalEmail

  # Dead Letter Queue for Transactional Emails
  TransactionalEmailDLQ:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub learnermax-transactional-email-dlq-${Environment}
      MessageRetentionPeriod: 1209600
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Project
          Value: LearnerMax
        - Key: Feature
          Value: TransactionalEmail

  # SNS Topic for Observability Alerts
  ObservabilityAlertTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: !Sub learnermax-observability-alerts-${Environment}
      DisplayName: LearnerMax Observability Alerts
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Project
          Value: LearnerMax

  # CloudWatch Alarm: DLQ Messages
  StudentOnboardingDLQAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub learnermax-student-onboarding-dlq-alarm-${Environment}
      AlarmDescription: Alert when messages arrive in Student Onboarding DLQ
      MetricName: ApproximateNumberOfMessagesVisible
      Namespace: AWS/SQS
      Statistic: Sum
      Period: 60
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Dimensions:
        - Name: QueueName
          Value: !GetAtt StudentOnboardingDLQ.QueueName
      AlarmActions:
        - !Ref ObservabilityAlertTopic
      TreatMissingData: notBreaching

  # CloudWatch Alarm: Lambda Errors
  StudentOnboardingErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub learnermax-student-onboarding-errors-${Environment}
      AlarmDescription: Alert on Student Onboarding Lambda errors
      MetricName: Errors
      Namespace: AWS/Lambda
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 5
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: FunctionName
          Value: !Ref StudentOnboardingFunction
      AlarmActions:
        - !Ref ObservabilityAlertTopic

  # PostConfirmation Lambda Function
  PostConfirmationFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ./
      Handler: dist/src/lambdas/post-confirmation.handler
      Runtime: nodejs22.x
      Architectures:
        - arm64
      MemorySize: 256
      Timeout: 10
      Description: Cognito PostConfirmation trigger - publishes to SNS
      Environment:
        Variables:
          SNS_TOPIC_ARN: !Ref StudentOnboardingTopic
      # ADOT layer removed - x86 collector binary incompatible with ARM64
      # TODO: Re-add when ARM64-compatible ADOT layer is available
      Policies:
        - SNSPublishMessagePolicy:
            TopicName: !GetAtt StudentOnboardingTopic.TopicName

  # Grant Cognito permission to invoke PostConfirmation Lambda
  PostConfirmationInvokePermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref PostConfirmationFunction
      Action: lambda:InvokeFunction
      Principal: cognito-idp.amazonaws.com

  # Student Onboarding Lambda Function
  StudentOnboardingFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ./
      Handler: dist/src/lambdas/student-onboarding.handler
      Runtime: nodejs22.x
      Architectures:
        - arm64
      MemorySize: 512
      Timeout: 30
      Description: Processes student onboarding events from SNS
      Environment:
        Variables:
          EDUCATION_TABLE_NAME: !Ref EducationTable
      # ADOT layer removed - x86 collector binary incompatible with ARM64
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref EducationTable
      DeadLetterQueue:
        Type: SQS
        TargetArn: !GetAtt StudentOnboardingDLQ.Arn
      Events:
        StudentOnboardingSNS:
          Type: SNS
          Properties:
            Topic: !Ref StudentOnboardingTopic

  # Transactional Email Function - Sends transactional emails for enrollment and meetup signup
  TransactionalEmailFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ./email/
      Handler: dist/handler.handler
      Runtime: nodejs22.x
      Architectures:
        - arm64
      MemorySize: 512
      Timeout: 30
      Description: Sends transactional emails for enrollment and meetup signup events
      Environment:
        Variables:
          EDUCATION_TABLE_NAME: !Ref EducationTable
          FRONTEND_DOMAIN: !Ref FrontendDomain
          SES_FROM_EMAIL: !Ref SESFromEmail
          SES_REPLY_TO_EMAIL: !Ref SESReplyToEmail
      # ADOT layer removed - x86 collector binary incompatible with ARM64
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref EducationTable
        - Statement:
            - Sid: SESSendEmail
              Effect: Allow
              Action:
                - ses:SendEmail
                - ses:SendRawEmail
              Resource: '*'
      DeadLetterQueue:
        Type: SQS
        TargetArn: !GetAtt TransactionalEmailDLQ.Arn
      Events:
        TransactionalEmailSNS:
          Type: SNS
          Properties:
            Topic: !Ref TransactionalEmailTopic

  # Express.js API Function using Lambda Web Adapter
  # Uses Provisioned Concurrency in production for zero cold starts
  ExpressApiFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ./
      Handler: run.sh
      Runtime: nodejs22.x
      Architectures:
        - arm64
      MemorySize: 2048
      Timeout: 30
      Description: Express.js API running on Lambda with Web Adapter
      # Provisioned Concurrency disabled - account concurrency quota too low (10)
      # TODO: Request quota increase via AWS Service Quotas, then uncomment:
      # AutoPublishAlias: live
      # ProvisionedConcurrencyConfig: !If
      #   - IsProd
      #   - ProvisionedConcurrentExecutions: 4
      #   - !Ref AWS::NoValue
      Environment:
        Variables:
          # Lambda Web Adapter configuration
          AWS_LAMBDA_EXEC_WRAPPER: /opt/bootstrap
          RUST_LOG: info
          PORT: 8080
          # Application configuration
          EDUCATION_TABLE_NAME: !Ref EducationTable
          COGNITO_USER_POOL_ID: !Ref LearnerMaxUserPool
          COGNITO_CLIENT_ID: !Ref LearnerMaxUserPoolClient
          # Video infrastructure configuration
          CLOUDFRONT_DOMAIN: !GetAtt VideoCloudFrontDistribution.DomainName
          CLOUDFRONT_KEY_PAIR_ID: !Ref CloudFrontPublicKeyId
          CLOUDFRONT_PRIVATE_KEY_SECRET_NAME: !Sub learnermax/cloudfront-private-key-${Environment}
          VIDEO_URL_EXPIRY_MINUTES: 30
          # SNS Topic for transactional emails
          TRANSACTIONAL_EMAIL_TOPIC_ARN: !Ref TransactionalEmailTopic
      Layers:
        # Lambda Web Adapter Layer (ARM64)
        - !Sub arn:aws:lambda:${AWS::Region}:753240598075:layer:LambdaAdapterLayerArm64:25
        # ADOT layer removed - x86 collector binary incompatible with ARM64
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref EducationTable
        - SNSPublishMessagePolicy:
            TopicName: !GetAtt TransactionalEmailTopic.TopicName
        - Statement:
            - Sid: ReadCloudFrontPrivateKey
              Effect: Allow
              Action:
                - secretsmanager:GetSecretValue
              Resource: !Sub arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:learnermax/cloudfront-private-key-${Environment}-*
      Events:
        RootEndpoint:
          Type: Api
          Properties:
            Path: /{proxy+}
            Method: ANY
            RestApiId: !Ref ApiGatewayApi
        # Public endpoints for SSG build-time fetching (no auth required)
        GetCourses:
          Type: Api
          Properties:
            Path: /api/courses
            Method: GET
            RestApiId: !Ref ApiGatewayApi
            Auth:
              Authorizer: NONE
        GetCourse:
          Type: Api
          Properties:
            Path: /api/courses/{courseId}
            Method: GET
            RestApiId: !Ref ApiGatewayApi
            Auth:
              Authorizer: NONE

  # API Gateway with Cognito authorization
  ApiGatewayApi:
    Type: AWS::Serverless::Api
    Properties:
      StageName: Prod
      OpenApiVersion: '3.0.1'
      Cors:
        AllowOrigin: "'*'"
        AllowHeaders: "'Content-Type,Authorization'"
        AllowMethods: "'GET,POST,PATCH,OPTIONS'"
      Auth:
        DefaultAuthorizer: CognitoAuthorizer
        AddDefaultAuthorizerToCorsPreflight: false
        Authorizers:
          CognitoAuthorizer:
            UserPoolArn: !GetAtt LearnerMaxUserPool.Arn
            Identity:
              Header: Authorization

  ApplicationResourceGroup:
    Type: AWS::ResourceGroups::Group
    Properties:
      Name:
        Fn::Sub: ApplicationInsights-SAM-${AWS::StackName}
      ResourceQuery:
        Type: CLOUDFORMATION_STACK_1_0
  ApplicationInsightsMonitoring:
    Type: AWS::ApplicationInsights::Application
    Properties:
      ResourceGroupName:
        Ref: ApplicationResourceGroup
      AutoConfigurationEnabled: 'true'

  # CloudWatch Dashboard for Observability
  # Layout: Business Metrics (rows 0-18), Technical Metrics (rows 18-36)
  ObservabilityDashboard:
    Type: AWS::CloudWatch::Dashboard
    Properties:
      DashboardName: !Sub LearnerMax-Observability-${Environment}
      DashboardBody: !Sub |
        {
          "widgets": [
            {
              "type": "text",
              "x": 0,
              "y": 0,
              "width": 24,
              "height": 1,
              "properties": {
                "markdown": "## Business Metrics"
              }
            },
            {
              "type": "metric",
              "x": 0,
              "y": 1,
              "width": 12,
              "height": 6,
              "properties": {
                "metrics": [
                  [{"expression": "SUM(SEARCH('{LearnerMax/Backend,service,signUpMethod} MetricName=\"UserRegistrationSuccess\"', 'Sum', 300))", "label": "UserRegistrationSuccess", "id": "e1"}],
                  [{"expression": "SUM(SEARCH('{LearnerMax/Backend,service,signUpMethod} MetricName=\"UserRegistrationFailure\"', 'Sum', 300))", "label": "UserRegistrationFailure", "id": "e2"}]
                ],
                "period": 300,
                "region": "${AWS::Region}",
                "title": "User Registrations",
                "yAxis": {"left": {"min": 0}}
              }
            },
            {
              "type": "metric",
              "x": 12,
              "y": 1,
              "width": 12,
              "height": 6,
              "properties": {
                "metrics": [
                  [{"expression": "SUM(SEARCH('{LearnerMax/Backend,service,signUpMethod} MetricName=\"UserRegistrationSuccess\"', 'Sum', 86400))", "label": "Signups", "id": "e1"}],
                  ["LearnerMax/Backend", "EnrollmentSuccess", "service", "EnrollmentService", {"label": "Enrollments"}]
                ],
                "period": 86400,
                "stat": "Sum",
                "region": "${AWS::Region}",
                "title": "Daily Signups & Enrollments",
                "yAxis": {"left": {"min": 0}}
              }
            },
            {
              "type": "metric",
              "x": 0,
              "y": 7,
              "width": 12,
              "height": 6,
              "properties": {
                "metrics": [
                  ["LearnerMax/Backend", "CourseCompletionSuccess", "service", "ProgressService"]
                ],
                "period": 86400,
                "stat": "Sum",
                "region": "${AWS::Region}",
                "title": "Daily Course Completions",
                "yAxis": {"left": {"min": 0}}
              }
            },
            {
              "type": "metric",
              "x": 12,
              "y": 7,
              "width": 12,
              "height": 6,
              "properties": {
                "metrics": [
                  ["LearnerMax/Backend", "PremiumEarlyAccessSignup", "service", "StudentService"]
                ],
                "period": 86400,
                "stat": "Sum",
                "region": "${AWS::Region}",
                "title": "Premium Early Access Signups",
                "yAxis": {"left": {"min": 0}}
              }
            },
            {
              "type": "metric",
              "x": 0,
              "y": 13,
              "width": 12,
              "height": 6,
              "properties": {
                "metrics": [
                  [{"expression": "100*m2/m1", "label": "Premium Rate %", "id": "e1"}],
                  [{"expression": "SUM(SEARCH('{LearnerMax/Backend,service,signUpMethod} MetricName=\"UserRegistrationSuccess\"', 'Sum', 86400))", "id": "m1", "visible": false}],
                  ["LearnerMax/Backend", "PremiumEarlyAccessSignup", "service", "StudentService", {"id": "m2", "visible": false}]
                ],
                "period": 86400,
                "stat": "Sum",
                "region": "${AWS::Region}",
                "title": "Premium Early Access Rate %",
                "yAxis": {"left": {"min": 0, "max": 100}}
              }
            },
            {
              "type": "metric",
              "x": 12,
              "y": 13,
              "width": 12,
              "height": 6,
              "properties": {
                "metrics": [
                  [{"expression": "100*m2/m1", "label": "Completion Rate %", "id": "e1"}],
                  [{"expression": "SUM(SEARCH('{LearnerMax/Backend,service,signUpMethod} MetricName=\"UserRegistrationSuccess\"', 'Sum', 86400))", "id": "m1", "visible": false}],
                  ["LearnerMax/Backend", "CourseCompletionSuccess", "service", "ProgressService", {"id": "m2", "visible": false}]
                ],
                "period": 86400,
                "stat": "Sum",
                "region": "${AWS::Region}",
                "title": "Course Completion Rate %",
                "yAxis": {"left": {"min": 0, "max": 100}}
              }
            },
            {
              "type": "text",
              "x": 0,
              "y": 19,
              "width": 24,
              "height": 1,
              "properties": {
                "markdown": "## Technical Metrics & Alerts"
              }
            },
            {
              "type": "metric",
              "x": 0,
              "y": 20,
              "width": 12,
              "height": 6,
              "properties": {
                "metrics": [
                  ["AWS/Lambda", "Errors", "FunctionName", "${PostConfirmationFunction}", {"label": "PostConfirmation"}],
                  ["...", "${StudentOnboardingFunction}", {"label": "StudentOnboarding"}],
                  ["...", "${ExpressApiFunction}", {"label": "ExpressApi"}]
                ],
                "period": 300,
                "stat": "Sum",
                "region": "${AWS::Region}",
                "title": "Lambda Errors",
                "yAxis": {"left": {"min": 0}}
              }
            },
            {
              "type": "metric",
              "x": 12,
              "y": 20,
              "width": 12,
              "height": 6,
              "properties": {
                "metrics": [
                  ["AWS/SQS", "ApproximateNumberOfMessagesVisible", "QueueName", "${StudentOnboardingDLQ.QueueName}", {"color": "#d13212"}]
                ],
                "period": 60,
                "stat": "Sum",
                "region": "${AWS::Region}",
                "title": "Dead Letter Queue (Alert: >0 needs attention)",
                "yAxis": {"left": {"min": 0}},
                "annotations": {
                  "horizontal": [{"color": "#d13212", "value": 1, "label": "Alert threshold"}]
                }
              }
            },
            {
              "type": "metric",
              "x": 0,
              "y": 26,
              "width": 12,
              "height": 6,
              "properties": {
                "metrics": [
                  ["LearnerMax/Backend", "Http5xxCount", "service", "ExpressApi", {"color": "#d13212"}]
                ],
                "period": 300,
                "stat": "Sum",
                "region": "${AWS::Region}",
                "title": "HTTP 5xx Errors (Alert: any is bad)",
                "yAxis": {"left": {"min": 0}},
                "annotations": {
                  "horizontal": [{"color": "#d13212", "value": 1, "label": "Alert threshold"}]
                }
              }
            },
            {
              "type": "metric",
              "x": 12,
              "y": 26,
              "width": 12,
              "height": 6,
              "properties": {
                "metrics": [
                  ["LearnerMax/Backend", "Http4xxCount", "service", "ExpressApi", {"color": "#ff9900"}]
                ],
                "period": 300,
                "stat": "Sum",
                "region": "${AWS::Region}",
                "title": "HTTP 4xx Errors",
                "yAxis": {"left": {"min": 0}}
              }
            },
            {
              "type": "metric",
              "x": 0,
              "y": 32,
              "width": 12,
              "height": 6,
              "properties": {
                "metrics": [
                  ["LearnerMax/Backend", "ApiLatency", "service", "ExpressApi", {"stat": "p50", "label": "p50"}],
                  ["...", {"stat": "p90", "label": "p90"}],
                  ["...", {"stat": "p99", "label": "p99", "color": "#d13212"}]
                ],
                "period": 300,
                "region": "${AWS::Region}",
                "title": "API Latency (p50/p90/p99 ms)",
                "yAxis": {"left": {"min": 0}},
                "annotations": {
                  "horizontal": [{"color": "#ff9900", "value": 2000, "label": "2s threshold"}]
                }
              }
            },
            {
              "type": "metric",
              "x": 12,
              "y": 32,
              "width": 12,
              "height": 6,
              "properties": {
                "metrics": [
                  ["AWS/Lambda", "Duration", "FunctionName", "${PostConfirmationFunction}", {"label": "PostConfirmation"}],
                  ["...", "${StudentOnboardingFunction}", {"label": "StudentOnboarding"}],
                  ["...", "${ExpressApiFunction}", {"label": "ExpressApi"}]
                ],
                "period": 300,
                "stat": "Average",
                "region": "${AWS::Region}",
                "title": "Lambda Duration (ms)",
                "yAxis": {"left": {"min": 0}}
              }
            }
          ]
        }

Outputs:
  WebEndpoint:
    Description: API Gateway endpoint URL for Prod stage
    Value: !Sub "https://${ApiGatewayApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/"

  UserPoolId:
    Description: Cognito User Pool ID
    Value: !Ref LearnerMaxUserPool
    Export:
      Name: !Sub ${AWS::StackName}-UserPoolId

  UserPoolClientId:
    Description: Cognito User Pool Client ID
    Value: !Ref LearnerMaxUserPoolClient
    Export:
      Name: !Sub ${AWS::StackName}-UserPoolClientId

  UserPoolDomain:
    Description: Cognito Hosted UI Domain
    Value: !Sub https://learnermax-${Environment}-${AWS::AccountId}.auth.${AWS::Region}.amazoncognito.com

  CognitoIssuerUrl:
    Description: Cognito Issuer URL for NextAuth
    Value: !Sub https://cognito-idp.${AWS::Region}.amazonaws.com/${LearnerMaxUserPool}

  StudentOnboardingTopicArn:
    Description: SNS Topic ARN for Student Onboarding
    Value: !Ref StudentOnboardingTopic
    Export:
      Name: !Sub ${AWS::StackName}-StudentOnboardingTopicArn

  TransactionalEmailTopicArn:
    Description: SNS Topic ARN for Transactional Email Events
    Value: !Ref TransactionalEmailTopic
    Export:
      Name: !Sub ${AWS::StackName}-TransactionalEmailTopicArn

  ExpressApiFunction:
    Description: Express API Lambda Function ARN
    Value: !GetAtt ExpressApiFunction.Arn

  ExpressApiFunctionIamRole:
    Description: Implicit IAM Role created for Express API function
    Value: !GetAtt ExpressApiFunctionRole.Arn

  DashboardUrl:
    Description: CloudWatch Dashboard URL for Observability
    Value: !Sub https://console.aws.amazon.com/cloudwatch/home?region=${AWS::Region}#dashboards:name=${ObservabilityDashboard}
    Export:
      Name: !Sub ${AWS::StackName}-DashboardUrl

  VideoStorageBucketName:
    Description: S3 bucket name for video storage
    Value: !Ref VideoStorageBucket
    Export:
      Name: !Sub ${AWS::StackName}-VideoStorageBucketName

  CloudFrontDistributionDomain:
    Description: CloudFront distribution domain for video delivery
    Value: !GetAtt VideoCloudFrontDistribution.DomainName
    Export:
      Name: !Sub ${AWS::StackName}-CloudFrontDistributionDomain

  CloudFrontDistributionId:
    Description: CloudFront distribution ID
    Value: !Ref VideoCloudFrontDistribution
    Export:
      Name: !Sub ${AWS::StackName}-CloudFrontDistributionId

# # More info about Globals: https://github.com/awslabs/serverless-application-model/blob/master/docs/globals.rst
Globals:
  Function:
    Tracing: Active
    # You can add LoggingConfig parameters such as the Logformat, Log Group, and SystemLogLevel or ApplicationLogLevel. Learn more here https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/sam-resource-function.html#sam-function-loggingconfig.
    LoggingConfig:
      LogFormat: JSON
  Api:
    TracingEnabled: true
