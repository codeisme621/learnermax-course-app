# LearnerMax Course Backend

This project contains a TypeScript Express.js API running on AWS Lambda using the AWS Lambda Web Adapter. It's deployed with the AWS Serverless Application Model (AWS SAM) CLI.

## Architecture

This application uses:
- **Express.js** - Web framework running on Lambda
- **AWS Lambda Web Adapter** - Allows Express.js to run seamlessly on Lambda
- **TypeScript** - Type-safe development
- **API Gateway** - HTTP endpoint routing
- **Amazon DynamoDB** - NoSQL database for data storage

## Project Structure

- `src/` - TypeScript source code
  - `app.ts` - Main Express.js application
  - `run.sh` - Lambda execution script
- `dist/` - Compiled JavaScript (generated by build)
- `events/` - Sample invocation events for testing
- `__tests__/` - Unit tests
- `template.yaml` - SAM template defining AWS resources
- `tsconfig.json` - TypeScript configuration
- `package.json` - Node.js dependencies and scripts

## Key Features

- Single Lambda function handling all routes via Express.js
- AWS Lambda Web Adapter for seamless Express.js integration
- TypeScript for type safety and better developer experience
- DynamoDB integration for data persistence

If you prefer to use an integrated development environment (IDE) to build and test your application, you can use the AWS Toolkit.  
The AWS Toolkit is an open-source plugin for popular IDEs that uses the AWS SAM CLI to build and deploy serverless applications on AWS. The AWS Toolkit also adds step-through debugging for Lambda function code. 

To get started, see the following:

* [CLion](https://docs.aws.amazon.com/toolkit-for-jetbrains/latest/userguide/welcome.html)
* [GoLand](https://docs.aws.amazon.com/toolkit-for-jetbrains/latest/userguide/welcome.html)
* [IntelliJ](https://docs.aws.amazon.com/toolkit-for-jetbrains/latest/userguide/welcome.html)
* [WebStorm](https://docs.aws.amazon.com/toolkit-for-jetbrains/latest/userguide/welcome.html)
* [Rider](https://docs.aws.amazon.com/toolkit-for-jetbrains/latest/userguide/welcome.html)
* [PhpStorm](https://docs.aws.amazon.com/toolkit-for-jetbrains/latest/userguide/welcome.html)
* [PyCharm](https://docs.aws.amazon.com/toolkit-for-jetbrains/latest/userguide/welcome.html)
* [RubyMine](https://docs.aws.amazon.com/toolkit-for-jetbrains/latest/userguide/welcome.html)
* [DataGrip](https://docs.aws.amazon.com/toolkit-for-jetbrains/latest/userguide/welcome.html)
* [VS Code](https://docs.aws.amazon.com/toolkit-for-vscode/latest/userguide/welcome.html)
* [Visual Studio](https://docs.aws.amazon.com/toolkit-for-visual-studio/latest/user-guide/welcome.html)

## Prerequisites

To use the AWS SAM CLI, you need the following tools:

* **AWS SAM CLI** - [Install the AWS SAM CLI](https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-sam-cli-install.html)
* **Node.js 22+** - [Install Node.js](https://nodejs.org/en/), including npm
* **Docker** - [Install Docker community edition](https://hub.docker.com/search/?type=edition&offering=community)
* **AWS CLI** - Configured with your credentials

## Getting Started

### 1. Install Dependencies

```bash
npm install
```

### 2. Build the Application

Compile TypeScript to JavaScript:

```bash
npm run build
```

Or use the Makefile:

```bash
make build
```

### 3. Run Tests

```bash
npm test
```

### 4. Local Development

Run the Express.js app locally:

```bash
npm run dev
```

The API will be available at `http://localhost:8080`

## Deployment

### First Time Deployment

```bash
# Build the TypeScript code
npm run build

# Build with SAM
sam build

# Deploy with guided prompts
sam deploy --guided
```

During deployment, you'll be prompted for:

* **Stack Name**: Unique name for your CloudFormation stack (e.g., `learnermax-course-backend`)
* **AWS Region**: AWS region for deployment (e.g., `us-east-1`)
* **Confirm changes before deploy**: Review changes before applying
* **Allow SAM CLI IAM role creation**: Required for DynamoDB access (choose `y`)
* **Save arguments to samconfig.toml**: Save settings for future deployments (choose `y`)

### Subsequent Deployments

After the first deployment:

```bash
make deploy
```

Or manually:

```bash
npm run build
sam build
sam deploy
```

The API Gateway endpoint URL will be displayed in the outputs when deployment completes.

## Local Testing with SAM

### Test with SAM Local API

The SAM CLI can emulate API Gateway locally:

```bash
sam local start-api
```

Then test the endpoints:

```bash
# Get all items
curl http://localhost:3000/

# Get item by ID
curl http://localhost:3000/123

# Create item
curl -X POST http://localhost:3000/ \
  -H "Content-Type: application/json" \
  -d '{"id":"123","name":"Test Item"}'
```

### Direct Local Development

For faster development without SAM, run the Express app directly:

```bash
# Set required environment variables
export SAMPLE_TABLE=YourTableName
export AWS_REGION=us-east-1

# Run the app
npm run dev
```

## API Endpoints

The application exposes the following REST API endpoints:

- `GET /` - Retrieve all items from DynamoDB
- `GET /{id}` - Retrieve a specific item by ID
- `POST /` - Create or update an item
  - Request body: `{"id": "string", "name": "string"}`
- `GET /health` - Health check endpoint

## Lambda Web Adapter Configuration

This application uses the [AWS Lambda Web Adapter](https://github.com/awslabs/aws-lambda-web-adapter) to run Express.js on Lambda. Key configuration in `template.yaml`:

```yaml
Environment:
  Variables:
    AWS_LAMBDA_EXEC_WRAPPER: /opt/bootstrap  # Enables Lambda Web Adapter
    PORT: 8080                                # Port Express listens on

Layers:
  - !Sub arn:aws:lambda:${AWS::Region}:753240598075:layer:LambdaAdapterLayerX86:25

Handler: run.sh  # Script that starts the Express app
```

The adapter allows standard HTTP frameworks to run on Lambda without modification.

## Monitoring and Logs

### View Lambda Logs

Tail logs in real-time:

```bash
sam logs -n ExpressApiFunction --stack-name <your-stack-name> --tail
```

### CloudWatch Logs

All logs are automatically sent to CloudWatch Logs. Access them via:
- AWS Console → CloudWatch → Log Groups
- Look for `/aws/lambda/<your-function-name>`

## Testing

Tests use Jest and TypeScript:

```bash
# Run all tests
npm test

# Run tests in watch mode
npm test -- --watch
```

Tests are located in `__tests__/unit/`.

## Available Scripts

- `npm run build` - Compile TypeScript to JavaScript
- `npm run start` - Start the Express server (production)
- `npm run dev` - Build and start the server (development)
- `npm test` - Run tests with Jest
- `npm run clean` - Remove compiled files

Makefile commands:
- `make install` - Install dependencies
- `make build` - Build TypeScript
- `make test` - Run tests
- `make deploy` - Build and deploy to AWS
- `make clean` - Clean build artifacts

## Cleanup

To delete the deployed application:

```bash
sam delete --stack-name <your-stack-name>
```

This will remove all AWS resources created by the stack.

## Resources

- [AWS SAM Developer Guide](https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/what-is-sam.html)
- [AWS Lambda Web Adapter](https://github.com/awslabs/aws-lambda-web-adapter)
- [Express.js Documentation](https://expressjs.com/)
- [TypeScript Documentation](https://www.typescriptlang.org/)
