# Slice 4.2: React Email Templates

**Parent Mainspec:** `specs/post_enrollment_email/mainspec.md`
**Status:** Not Started
**Depends On:** Slice 4.1 (SNS Topic & Infrastructure - handler file must exist)

## Objective
Create professional, responsive HTML email templates using React Email (`@react-email/components`):
1. **Enrollment Confirmation Email** - Welcome email with course link
2. **Meetup Calendar Invite Email** - Signup confirmation with .ics attachment

The templates will live in the `backend/email/` package alongside the Lambda handler, making it a complete, self-contained email service. Additionally, this slice includes .ics calendar file generation for meetup invites.

## What We're Doing

### 1. Initialize Email Package

**Create:** `backend/email/package.json`

```json
{
  "name": "@learnermax/email",
  "version": "1.0.0",
  "private": true,
  "type": "module",
  "scripts": {
    "dev": "email dev --dir ./emails --port 3001",
    "build": "tsc",
    "export": "email export"
  },
  "dependencies": {
    "react": "^18.3.1",
    "@react-email/components": "^0.0.25",
    "@react-email/render": "^1.0.1",
    "ics": "^3.8.1",
    "luxon": "^3.5.0"
  },
  "devDependencies": {
    "@react-email/cli": "^1.0.3",
    "@types/react": "^18.3.12",
    "typescript": "^5.7.2"
  }
}
```

**Create:** `backend/email/tsconfig.json`

```json
{
  "compilerOptions": {
    "target": "ES2022",
    "module": "ESNext",
    "lib": ["ES2022"],
    "moduleResolution": "bundler",
    "jsx": "react",
    "outDir": "./dist",
    "rootDir": "./",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true,
    "resolveJsonModule": true,
    "declaration": true,
    "declarationMap": true
  },
  "include": ["**/*.ts", "**/*.tsx"],
  "exclude": ["node_modules", "dist", ".react-email"]
}
```

**Install dependencies:**
```bash
cd backend/email
pnpm install
```

**Final directory structure:**
```
backend/
â””â”€â”€ email/
    â”œâ”€â”€ handler.ts         # Lambda handler (from Slice 4.1)
    â”œâ”€â”€ render.ts          # Email rendering + event router (NEW)
    â”œâ”€â”€ types.ts           # Event and email data types (UPDATE)
    â”œâ”€â”€ emails/
    â”‚   â”œâ”€â”€ enrollment-email.tsx  # Email template (NEW)
    â”‚   â””â”€â”€ index.ts
    â”œâ”€â”€ components/
    â”‚   â”œâ”€â”€ header.tsx
    â”‚   â”œâ”€â”€ footer.tsx
    â”‚   â””â”€â”€ index.ts
    â”œâ”€â”€ package.json       # NEW
    â”œâ”€â”€ tsconfig.json      # NEW
    â””â”€â”€ .react-email/      # Auto-generated by dev server
```

### 2. Update Email Data Types

**Update:** `backend/email/types.ts`

Add email-specific types alongside the existing SNS event types:

```typescript
// SNS Event Types
export interface EnrollmentCompletedEvent {
  eventType: 'EnrollmentCompleted';
  studentId: string;
  courseId: string;
  enrollmentType: 'free' | 'paid';
  enrolledAt: string;
  source: 'manual' | 'auto';
}

// Email Data Types
export interface EnrollmentEmailData {
  studentName: string;           // "Alex Johnson"
  studentEmail: string;          // "alex@example.com"
  courseName: string;            // "Spec-Driven Development with Context Engineering"
  courseUrl: string;             // "https://learnermax.com/course/spec-driven-dev-mini"
  courseDescription: string;     // Brief course description
  instructor: string;            // "Rico Romero"
  totalLessons: number;          // 3
  estimatedDuration: string;     // "45 minutes"
  enrolledAt: string;            // "January 15, 2025" (formatted)
  pricingModel: 'free' | 'paid';
}
```

### 3. Create Reusable Email Components

**Create:** `backend/email/components/header.tsx`

```tsx
import { Img, Section } from '@react-email/components';

export function Header() {
  return (
    <Section style={headerSection}>
      <Img
        src="https://learnermax.com/logo.png"
        width="150"
        height="40"
        alt="LearnerMax"
        style={logo}
      />
    </Section>
  );
}

const headerSection = {
  padding: '20px 0',
  borderBottom: '1px solid #e5e7eb',
  marginBottom: '32px',
};

const logo = {
  margin: '0 auto',
  display: 'block',
};
```

**Create:** `backend/email/components/footer.tsx`

```tsx
import { Section, Text, Hr, Link } from '@react-email/components';

export function Footer() {
  return (
    <>
      <Hr style={divider} />
      <Section style={footerSection}>
        <Text style={footerText}>
          Questions? Reply to this email and we'll be happy to help.
        </Text>
        <Text style={footerText}>
          The LearnerMax Team
        </Text>
        <Text style={legalText}>
          This is a transactional email confirming your course enrollment.
        </Text>
        <Text style={legalText}>
          <Link href="https://learnermax.com" style={link}>
            LearnerMax
          </Link>
          {' â€¢ '}
          <Link href="https://learnermax.com/privacy" style={link}>
            Privacy Policy
          </Link>
          {' â€¢ '}
          <Link href="https://learnermax.com/terms" style={link}>
            Terms of Service
          </Link>
        </Text>
      </Section>
    </>
  );
}

const divider = {
  borderColor: '#e5e7eb',
  margin: '32px 0',
};

const footerSection = {
  marginTop: '32px',
  textAlign: 'center' as const,
};

const footerText = {
  color: '#6b7280',
  fontSize: '14px',
  lineHeight: '24px',
  margin: '8px 0',
};

const legalText = {
  color: '#9ca3af',
  fontSize: '12px',
  lineHeight: '20px',
  margin: '8px 0',
};

const link = {
  color: '#3b82f6',
  textDecoration: 'none',
};
```

**Create:** `backend/email/components/index.ts`

```typescript
export { Header } from './header';
export { Footer } from './footer';
```

### 4. Create Enrollment Email Template

**Create:** `backend/email/emails/enrollment-email.tsx`

```tsx
import {
  Html,
  Head,
  Body,
  Container,
  Section,
  Text,
  Button,
  Heading,
  Hr
} from '@react-email/components';
import { Header, Footer } from '../components';

interface EnrollmentEmailProps {
  studentName: string;
  courseName: string;
  courseUrl: string;
  courseDescription: string;
  instructor: string;
  totalLessons: number;
  estimatedDuration: string;
  enrolledAt: string;
  pricingModel: 'free' | 'paid';
}

export default function EnrollmentEmail(props: EnrollmentEmailProps) {
  const {
    studentName,
    courseName,
    courseUrl,
    courseDescription,
    instructor,
    totalLessons,
    estimatedDuration,
    enrolledAt,
    pricingModel
  } = props;

  return (
    <Html>
      <Head />
      <Body style={body}>
        <Container style={container}>
          <Header />

          <Section>
            <Heading style={h1}>
              Welcome to {courseName}! ðŸŽ‰
            </Heading>

            <Text style={greeting}>
              Hi {studentName},
            </Text>

            <Text style={paragraph}>
              You're all set to start learning! Your enrollment is confirmed and you can
              access your course anytime.
            </Text>

            {/* Course Card */}
            <Section style={courseCard}>
              <Heading as="h2" style={h2}>
                {courseName}
              </Heading>

              <Text style={courseDescriptionStyle}>
                {courseDescription}
              </Text>

              <Hr style={cardDivider} />

              <Section style={courseDetails}>
                <Text style={detailItem}>
                  <strong>Instructor:</strong> {instructor}
                </Text>
                <Text style={detailItem}>
                  <strong>Lessons:</strong> {totalLessons} lessons
                </Text>
                <Text style={detailItem}>
                  <strong>Duration:</strong> {estimatedDuration}
                </Text>
                {pricingModel === 'free' && (
                  <Text style={detailItem}>
                    <strong>Price:</strong> Free
                  </Text>
                )}
                <Text style={detailItem}>
                  <strong>Enrolled:</strong> {enrolledAt}
                </Text>
              </Section>

              <Button href={courseUrl} style={button}>
                Start Learning
              </Button>
            </Section>

            {/* What to Expect */}
            <Section style={expectationSection}>
              <Heading as="h3" style={h3}>
                What to Expect
              </Heading>
              <Text style={paragraph}>
                {courseDescription}
              </Text>
            </Section>
          </Section>

          <Footer />
        </Container>
      </Body>
    </Html>
  );
}

// Styles
const body = {
  backgroundColor: '#f3f4f6',
  fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif',
};

const container = {
  backgroundColor: '#ffffff',
  margin: '0 auto',
  padding: '20px 40px',
  maxWidth: '600px',
};

const h1 = {
  color: '#111827',
  fontSize: '28px',
  fontWeight: '700',
  lineHeight: '36px',
  margin: '32px 0 16px',
};

const h2 = {
  color: '#111827',
  fontSize: '22px',
  fontWeight: '700',
  lineHeight: '30px',
  margin: '0 0 12px',
};

const h3 = {
  color: '#111827',
  fontSize: '18px',
  fontWeight: '600',
  lineHeight: '26px',
  margin: '24px 0 12px',
};

const greeting = {
  color: '#374151',
  fontSize: '16px',
  lineHeight: '24px',
  margin: '16px 0',
};

const paragraph = {
  color: '#374151',
  fontSize: '16px',
  lineHeight: '24px',
  margin: '16px 0',
};

const courseCard = {
  backgroundColor: '#f9fafb',
  border: '2px solid #e5e7eb',
  borderRadius: '8px',
  padding: '24px',
  margin: '24px 0',
};

const courseDescriptionStyle = {
  color: '#6b7280',
  fontSize: '15px',
  lineHeight: '22px',
  margin: '12px 0',
};

const cardDivider = {
  borderColor: '#e5e7eb',
  margin: '16px 0',
};

const courseDetails = {
  margin: '16px 0',
};

const detailItem = {
  color: '#374151',
  fontSize: '14px',
  lineHeight: '20px',
  margin: '8px 0',
};

const button = {
  backgroundColor: '#3b82f6',
  borderRadius: '6px',
  color: '#ffffff',
  fontSize: '16px',
  fontWeight: '600',
  textDecoration: 'none',
  textAlign: 'center' as const,
  display: 'block',
  padding: '12px 24px',
  margin: '16px 0 0',
};

const expectationSection = {
  marginTop: '32px',
};

// Preview props for React Email dev server
EnrollmentEmail.PreviewProps = {
  studentName: 'Alex Johnson',
  courseName: 'Spec-Driven Development with Context Engineering',
  courseUrl: 'https://learnermax.com/course/spec-driven-dev-mini',
  courseDescription: 'Learn how to build better software with AI collaboration by mastering spec writing and context engineering techniques. Perfect for developers who want to work more effectively with tools like Claude Code, GitHub Copilot, and other AI coding assistants.',
  instructor: 'Rico Romero',
  totalLessons: 3,
  estimatedDuration: '45 minutes',
  enrolledAt: 'January 15, 2025',
  pricingModel: 'free' as const,
} as EnrollmentEmailProps;
```

**Create:** `backend/email/emails/index.ts`

```typescript
export { default as EnrollmentEmail } from './enrollment-email';
export { default as MeetupCalendarInviteEmail } from './meetup-calendar-invite-email';
```

### 4.5. Create Meetup Calendar Invite Email Template

**Create:** `backend/email/emails/meetup-calendar-invite-email.tsx`

```tsx
import {
  Html,
  Head,
  Body,
  Container,
  Section,
  Text,
  Heading,
  Hr,
  Preview
} from '@react-email/components';
import { EmailHeader, EmailFooter } from './components';

export interface MeetupCalendarInviteEmailProps {
  studentName: string;
  meetupTitle: string;
  meetupDescription: string;
  formattedDateTime: string;
  duration: number;
  zoomLink: string;
  hostName: string;
}

export default function MeetupCalendarInviteEmail({
  studentName,
  meetupTitle,
  meetupDescription,
  formattedDateTime,
  duration,
  zoomLink,
  hostName
}: MeetupCalendarInviteEmailProps) {
  return (
    <Html>
      <Head />
      <Preview>You're signed up for {meetupTitle} - Calendar invite attached</Preview>
      <Body style={main}>
        <Container style={container}>
          <EmailHeader />

          <Heading style={h1}>You're Signed Up! ðŸ“…</Heading>

          <Text style={text}>Hi {studentName},</Text>

          <Text style={text}>
            You're all set for our weekly meetup. We've attached a calendar invite
            (.ics file) to this email so you can add it to your calendar with one click.
          </Text>

          {/* Meetup Details Card */}
          <Section style={meetupCard}>
            <Heading as="h2" style={h2}>
              {meetupTitle}
            </Heading>

            <Section style={detailsSection}>
              <Text style={detailLabel}>When</Text>
              <Text style={detailValue}>{formattedDateTime}</Text>
            </Section>

            <Section style={detailsSection}>
              <Text style={detailLabel}>Duration</Text>
              <Text style={detailValue}>{duration} minutes</Text>
            </Section>

            <Section style={detailsSection}>
              <Text style={detailLabel}>Host</Text>
              <Text style={detailValue}>{hostName}</Text>
            </Section>
          </Section>

          {/* About Section */}
          <Section style={aboutSection}>
            <Heading as="h3" style={h3}>
              About This Meetup
            </Heading>
            <Text style={text}>{meetupDescription}</Text>
          </Section>

          {/* Zoom Link Section */}
          <Section style={zoomSection}>
            <Text style={text}>
              <strong>Zoom Link:</strong>{' '}
              <a href={zoomLink} style={link}>
                {zoomLink}
              </a>
            </Text>
            <Text style={smallText}>
              Note: The Zoom link is also included in the calendar invite attachment.
            </Text>
          </Section>

          <Hr style={hr} />

          <Text style={smallText}>
            <strong>To add this meetup to your calendar:</strong> Open the attached .ics file.
            It works with Google Calendar, Outlook, Apple Calendar, and most other calendar apps.
          </Text>

          <EmailFooter />
        </Container>
      </Body>
    </Html>
  );
}

// Styles
const main = {
  backgroundColor: '#f6f9fc',
  fontFamily:
    '-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Ubuntu,sans-serif',
};

const container = {
  backgroundColor: '#ffffff',
  margin: '0 auto',
  padding: '20px 0 48px',
  marginBottom: '64px',
  maxWidth: '600px',
};

const h1 = {
  color: '#1a1a1a',
  fontSize: '32px',
  fontWeight: '700',
  margin: '40px 0',
  padding: '0 40px',
  lineHeight: '1.3',
};

const h2 = {
  color: '#1a1a1a',
  fontSize: '24px',
  fontWeight: '600',
  margin: '0 0 16px',
};

const h3 = {
  color: '#1a1a1a',
  fontSize: '20px',
  fontWeight: '600',
  margin: '0 0 12px',
};

const text = {
  color: '#484848',
  fontSize: '16px',
  lineHeight: '1.6',
  margin: '16px 40px',
};

const smallText = {
  color: '#666',
  fontSize: '14px',
  lineHeight: '1.5',
  margin: '8px 40px',
};

const meetupCard = {
  backgroundColor: '#f8f9fa',
  borderRadius: '8px',
  padding: '24px',
  margin: '24px 40px',
};

const detailsSection = {
  marginBottom: '16px',
};

const detailLabel = {
  color: '#666',
  fontSize: '14px',
  fontWeight: '500',
  margin: '0 0 4px 0',
  textTransform: 'uppercase' as const,
  letterSpacing: '0.5px',
};

const detailValue = {
  color: '#1a1a1a',
  fontSize: '16px',
  margin: '0',
};

const aboutSection = {
  margin: '24px 40px',
};

const zoomSection = {
  backgroundColor: '#e3f2fd',
  borderRadius: '8px',
  padding: '16px 24px',
  margin: '24px 40px',
};

const link = {
  color: '#2563eb',
  textDecoration: 'underline',
  wordBreak: 'break-all' as const,
};

const hr = {
  borderColor: '#e6e6e6',
  margin: '32px 40px',
};
```

### 4.6. Create ICS Calendar File Generator

**Create:** `backend/email/utils/generateIcs.ts`

```typescript
import { createEvent, EventAttributes, DateArray } from 'ics';
import { DateTime } from 'luxon';

export interface MeetupEventData {
  meetupTitle: string;
  meetupDescription: string;
  nextOccurrence: string;  // ISO timestamp
  duration: number;         // minutes
  zoomLink: string;
  hostName: string;
  hostEmail: string;
  studentName: string;
  studentEmail: string;
}

export function generateMeetupIcs(data: MeetupEventData): Buffer {
  const startDateTime = DateTime.fromISO(data.nextOccurrence);

  // Convert to DateArray format: [year, month, day, hour, minute]
  const start: DateArray = [
    startDateTime.year,
    startDateTime.month,
    startDateTime.day,
    startDateTime.hour,
    startDateTime.minute,
  ];

  const event: EventAttributes = {
    start,
    duration: { minutes: data.duration },
    title: data.meetupTitle,
    description: `${data.meetupDescription}\\n\\nZoom Link: ${data.zoomLink}`,
    location: data.zoomLink,
    url: data.zoomLink,
    organizer: {
      name: data.hostName,
      email: data.hostEmail,
    },
    attendees: [
      {
        name: data.studentName,
        email: data.studentEmail,
        rsvp: true,
        partstat: 'NEEDS-ACTION',
        role: 'REQ-PARTICIPANT',
      },
    ],
    status: 'CONFIRMED',
    busyStatus: 'BUSY',
    method: 'REQUEST',
  };

  const { error, value } = createEvent(event);

  if (error) {
    console.error('Failed to generate ICS file', { error, data });
    throw new Error(`ICS generation failed: ${error.message}`);
  }

  if (!value) {
    throw new Error('ICS generation returned no value');
  }

  return Buffer.from(value, 'utf-8');
}
```

**Create:** `backend/email/utils/index.ts`

```typescript
export { generateMeetupIcs } from './generateIcs';
```

### 5. Create Email Rendering Utility with Event Router

**Create:** `backend/email/render.ts`

This is the key integration point - it routes SNS event types to the appropriate email template:

```typescript
import { render } from '@react-email/render';
import { EnrollmentEmail } from './emails';
import type { EnrollmentEmailData } from './types';

/**
 * Render email HTML from SNS event type and data
 * This is the main entry point for the Lambda handler
 */
export async function renderEmailFromEvent(
  eventType: string,
  data: any
): Promise<{ html: string; subject: string }> {
  switch (eventType) {
    case 'EnrollmentCompleted':
      return renderEnrollmentEmail(data);

    // Future email types can be added here:
    // case 'CourseCompleted':
    //   return renderCourseCompletionEmail(data);
    // case 'ProgressMilestone':
    //   return renderProgressReminderEmail(data);

    default:
      throw new Error(`Unknown email event type: ${eventType}`);
  }
}

/**
 * Render enrollment email
 */
async function renderEnrollmentEmail(
  data: EnrollmentEmailData
): Promise<{ html: string; subject: string }> {
  const html = await render(EnrollmentEmail(data), {
    pretty: false,
  });

  const subject = `Welcome to ${data.courseName} - Let's Get Started!`;

  return { html, subject };
}
```

### 6. Update Backend Build Process

**Update:** `backend/package.json`

Add scripts to build the email package before building the main backend:

```json
{
  "scripts": {
    "build": "npm run email:build && tsc",
    "email:build": "cd email && pnpm install && pnpm build",
    "email:dev": "cd email && pnpm dev",
    "dev": "tsx watch src/index.ts"
  }
}
```

### 7. Development Preview Server

**Start React Email dev server:**
```bash
cd backend/email
pnpm install
pnpm run dev
```

This starts a local server at `http://localhost:3001` where you can preview the email template with hot reload.

**Navigate to:**
```
http://localhost:3001
```

Click on "enrollment-email" in the sidebar to see the template rendered with preview data.

## What We're NOT Doing
- No inline CSS optimization (React Email handles this)
- No dark mode support (email clients have limited support)
- No image attachments (just external images via URL)
- No personalized recommendations
- No A/B testing different templates
- No multi-language support

## Acceptance Criteria

### Email Package Setup
- [ ] `backend/email/package.json` created
- [ ] React and @react-email dependencies installed
- [ ] `tsconfig.json` configured for React JSX
- [ ] Dependencies install successfully: `pnpm install`
- [ ] Email package is separate from main backend package

### Email Components
- [ ] Header component created with logo
- [ ] Footer component created with legal text and links
- [ ] Components exported from `components/index.ts`
- [ ] Inline styles defined for email client compatibility

### Email Template
- [ ] EnrollmentEmail template created in `emails/enrollment-email.tsx`
- [ ] Template accepts all required props
- [ ] All fields displayed correctly
- [ ] "Start Learning" button links to courseUrl
- [ ] Course card styled with border and background
- [ ] PreviewProps defined for dev server

### Email Rendering
- [ ] `render.ts` exports `renderEmailFromEvent()` function
- [ ] Event router supports 'EnrollmentCompleted' event type
- [ ] Returns both HTML and subject line
- [ ] Throws error for unknown event types

### Development Experience
- [ ] Dev server starts: `pnpm run email:dev`
- [ ] Template visible at http://localhost:3001
- [ ] Hot reload works when editing template
- [ ] Build script works: `pnpm run email:build`

### Backend Integration
- [ ] Backend build process compiles email package first
- [ ] Email package compiles to `email/dist/`
- [ ] No TypeScript errors in email package

## Forward-Looking Requirements

### For Slice 4.3 (Email Service & SES Integration)
- Lambda handler will import `renderEmailFromEvent()` from `./render.js`
- Handler receives SNS event â†’ calls `renderEmailFromEvent()` â†’ sends via SES

### For Slice 4.5 (Complete Email Lambda Handler)
**Update `handler.ts` to use email renderer:**
```typescript
import { renderEmailFromEvent } from './render.js';

export const handler: SNSHandler = async (event: SNSEvent) => {
  for (const record of event.Records) {
    const { eventType, ...data } = JSON.parse(record.Sns.Message);

    // Fetch additional data from DynamoDB (Slice 4.3)
    const emailData = await fetchEmailData(data);

    // Render email
    const { html, subject } = await renderEmailFromEvent(eventType, emailData);

    // Send via SES (Slice 4.3)
    await sendEmail({ html, subject, to: emailData.studentEmail });
  }
};
```

### For Future Email Templates
**Add new templates following same pattern:**
```tsx
// backend/email/emails/course-completion-email.tsx
export default function CourseCompletionEmail(props) { ... }

// Update render.ts
case 'CourseCompleted':
  return renderCourseCompletionEmail(data);
```

## Verification Steps

After creating email package:

1. **Install dependencies:**
   ```bash
   cd backend/email
   pnpm install
   ```

2. **Start dev server:**
   ```bash
   pnpm run dev
   ```
   Should output:
   ```
   âœ“ React Email dev server ready
   âžœ Local:   http://localhost:3001
   ```

3. **Preview in browser:**
   - Navigate to http://localhost:3001
   - Click "enrollment-email" in sidebar
   - Verify template renders with preview data
   - Check button link works
   - Resize browser to test responsive layout

4. **Build email package:**
   ```bash
   pnpm run build
   ```
   Verify `dist/` directory created with compiled JS files

5. **Build backend (including email):**
   ```bash
   cd backend
   pnpm run build
   ```
   Verify no errors and email package builds first

## User Flow Narrative

**Scenario: Developer previews email template**

1. **Context:** Email template needs to be designed and tested before integration.

2. **Start dev server:**
   ```bash
   cd backend/email
   pnpm install
   pnpm run dev
   ```

3. **Preview opens:** Browser shows React Email dev server at http://localhost:3001 with "enrollment-email" in sidebar.

4. **Click template:** Developer clicks "enrollment-email" and sees the rendered email with welcome message, course card, and blue "Start Learning" button.

5. **Edit and iterate:** Developer opens `enrollment-email.tsx` and changes the button color. Browser auto-refreshes with the new color.

6. **Test button:** Developer clicks "Start Learning" in preview. Opens course URL in new tab. âœ“

7. **Ready to integrate:** Template looks great. Now ready for Lambda handler to use `renderEmailFromEvent()`.

## Deviations from Plan
_(To be filled during implementation)_

Potential considerations:
- May adjust port if 3001 conflicts with other services
- May add more reusable components (Button, CourseCard)
- May add email preview screenshots to documentation
- May optimize build output if bundle size becomes large
